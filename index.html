<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MULTI-AGENT PARTY</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            --highlight-a: #ff3333; /* A: ç´… */
            --highlight-b: #3388ff; /* B: è— */
            --highlight-c: #ffcc00; /* C: é»ƒ */
            --highlight-d: #bd00ff; /* D: ç´« */
            --common: #00ff41;      /* ç¶  */
            --wait: #444444;        /* å¾…æ©Ÿç° */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }

        /* --- 1. äººæ•¸è¨­å®šèˆ‡è§’è‰²é¸æ“‡ --- */
        #screen-setup {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        
        .setup-title { font-size: 1.5rem; margin-bottom: 20px; text-align: center; letter-spacing: 2px; color: var(--common); }

        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; margin-bottom: 30px; }
        
        .setup-btn {
            padding: 20px; background: #111; border: 2px solid #444; color: #888;
            font-size: 1.2rem; border-radius: 12px; font-weight: bold; cursor: pointer;
        }
        .setup-btn.selected {
            background: #222; border-color: var(--common); color: var(--common); box-shadow: 0 0 15px rgba(0,255,65,0.2);
        }

        .role-list { display: flex; flex-direction: column; width: 100%; max-width: 350px; gap: 10px; }
        .role-btn {
            padding: 20px; border: 2px solid #333; background: #000; color: #fff;
            font-size: 1.2rem; border-radius: 12px; text-align: left; font-weight: bold;
            display: flex; align-items: center;
        }
        .role-indicator { width: 15px; height: 15px; border-radius: 50%; margin-right: 15px; }

        /* --- 2. éŠæˆ²ä¸»ç•«é¢ --- */
        #screen-game {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: 20px; padding-bottom: 80px; overflow-y: auto;
        }

        /* é ‚éƒ¨è³‡è¨Š */
        .top-bar {
            width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px;
        }
        .level-badge { background: #222; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; color: #fff; }
        .turn-badge { font-weight: bold; font-size: 1rem; }

        /* ä¸»æ§æ¨¡å¼ (Active) */
        .active-zone { width: 100%; max-width: 400px; text-align: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        .target-card {
            background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 16px; padding: 20px; margin-bottom: 20px;
        }
        .target-icon { font-size: 5rem; display: block; margin-bottom: 10px; animation: bounce 2s infinite; }
        .target-name { font-size: 1.8rem; font-weight: 900; color: #fff; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        .instruction { color: var(--common); font-size: 1.1rem; margin-bottom: 20px; border: 1px dashed var(--common); padding: 10px; border-radius: 8px; display: inline-block; }

        .game-input {
            background: #000; border: 2px solid #666; color: #fff; font-size: 2rem; padding: 15px; width: 100%; 
            text-align: center; border-radius: 12px; margin-bottom: 15px; letter-spacing: 3px; outline: none;
        }
        .unlock-btn {
            width: 100%; padding: 15px; font-size: 1.3rem; font-weight: bold; background: #e0e0e0; border: none; border-radius: 12px; color: #000;
        }

        /* å¾…æ©Ÿæ¨¡å¼ (Passive) */
        .passive-zone { width: 100%; max-width: 400px; text-align: center; margin-top: 20px; opacity: 0.6; }
        .waiting-text { font-size: 1.5rem; color: #888; margin-bottom: 10px; }
        .waiting-sub { font-size: 1rem; color: #555; }

        /* åº•éƒ¨æ§åˆ¶åˆ— (åŒæ­¥æŒ‰éˆ•) */
        .bottom-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: #111; border-top: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
        }
        .sync-btn {
            flex: 1; padding: 15px; background: #222; color: #fff; border: 1px solid #444; border-radius: 8px; font-weight: bold; font-size: 1rem;
        }
        .sync-btn:active { background: var(--common); color: #000; }

        /* å¯†ç¢¼æœ¬æŒ‰éˆ• (å¦‚æœæˆ‘æ˜¯åŠ©æ‰‹ï¼Œæœƒç™¼å…‰) */
        .book-btn {
            flex: 1; margin-right: 10px; padding: 15px; background: #000; color: var(--common); 
            border: 1px solid var(--common); border-radius: 8px; font-weight: bold; font-size: 1rem;
        }
        .book-btn.highlight {
            background: var(--common); color: #000; animation: pulseBtn 1s infinite alternate;
        }
        @keyframes pulseBtn { from {box-shadow: 0 0 5px var(--common);} to {box-shadow: 0 0 20px var(--common);} }

        /* --- 3. å¯†ç¢¼æœ¬è¦–çª— --- */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 100; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #222; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; background: #000; padding: 10px; gap: 5px; }
        .tab-btn { flex: 1; padding: 10px 0; background: #111; color: #666; border: 1px solid #333; }
        .tab-btn.active { background: #222; color: var(--common); border-color: var(--common); }
        #code-list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .code-item { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; }
        .item-code { color: var(--common); font-size: 1.4rem; font-weight: bold; margin: 5px 0; }

        /* --- 4. æˆåŠŸç•«é¢ --- */
        #screen-success {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,40,0,0.95); z-index: 90;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

    </style>
</head>
<body>

    <div id="screen-setup">
        <div class="setup-title">STEP 1: é¸æ“‡ç¸½äººæ•¸</div>
        <div class="option-grid">
            <button class="setup-btn" onclick="setPlayerCount(2)">2 äºº</button>
            <button class="setup-btn" onclick="setPlayerCount(3)">3 äºº</button>
            <button class="setup-btn" onclick="setPlayerCount(4)">4 äºº</button>
        </div>

        <div id="role-selection" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="setup-title">STEP 2: é¸æ“‡ä½ çš„èº«åˆ†</div>
            <div id="role-buttons" class="role-list">
                </div>
        </div>
    </div>

    <div id="screen-game" class="hidden">
        <div class="top-bar">
            <div class="level-badge" id="level-display">LEVEL 1</div>
            <div class="turn-badge" id="turn-display" style="color: var(--highlight-a);">TURN: AGENT A</div>
        </div>

        <div id="active-view" class="active-zone hidden">
            <div class="target-card">
                <span id="target-icon" class="target-icon">â“</span>
                <div id="target-name" class="target-name">LOADING...</div>
                <div id="target-en" style="color:var(--common); font-weight:bold;">...</div>
            </div>

            <div id="instruction-box" class="instruction">
                ğŸ“¡ å‘¼å« <span id="helper-name" style="font-weight:bold;">AGENT ?</span> ç´¢å–ä»£ç¢¼
            </div>

            <input type="text" id="input-code" class="game-input" placeholder="CODE" maxlength="4">
            <button class="unlock-btn" onclick="checkCode()">è§£é– / UNLOCK</button>
        </div>

        <div id="passive-view" class="passive-zone hidden">
            <div style="font-size:3rem; margin-bottom:20px;">â³</div>
            <div class="waiting-text">é€£ç·šå¾…æ©Ÿä¸­...</div>
            <div class="waiting-sub">ç›®å‰è¡Œå‹•ï¼š<span id="current-turn-name">AGENT ?</span></div>
            <div class="waiting-sub" style="margin-top:20px; color:#666;">è«‹ç­‰å¾…éšŠå‹è§£é™¤å±æ©Ÿ</div>
        </div>
    </div>

    <div id="bottom-bar" class="bottom-controls hidden">
        <button id="btn-book" class="book-btn" onclick="openCodebook()">ğŸ“– å¯†ç¢¼æœ¬</button>
        <button class="sync-btn" onclick="manualNextLevel()">è·³é / ä¸‹ä¸€é—œ â­</button>
    </div>

    <div id="screen-success" class="hidden">
        <div style="font-size:5rem;">âœ…</div>
        <h1 style="color:#fff;">SUCCESS</h1>
        <p style="color:#aaa;">è«‹æ‰€æœ‰äººæŒ‰ä¸‹ã€Œä¸‹ä¸€é—œã€</p>
        <button class="sync-btn" style="width:200px; margin-top:20px;" onclick="manualNextLevel()">ä¸‹ä¸€é—œ â­</button>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-header">
            <div style="color:#fff; font-weight:bold;">å”åŠ©éšŠå‹</div>
            <button style="background:none; border:none; color:#fff; font-size:2rem;" onclick="closeCodebook()">âœ•</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('fruits')" id="tab-fruits">æ°´æœ</button>
            <button class="tab-btn" onclick="switchTab('animals')" id="tab-animals">å‹•ç‰©</button>
            <button class="tab-btn" onclick="switchTab('plants')" id="tab-plants">æ¤ç‰©</button>
        </div>
        <div id="code-list"></div>
    </div>

    <script>
        // --- è³‡æ–™åº« (4çµ„) ---
        const database = {
            A: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'A101'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'A102'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'A201'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'A202'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'A301'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'A302'}]
            },
            B: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'B101'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'B102'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'B201'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'B202'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'B301'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'B302'}]
            },
            C: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'C101'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'C102'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'C201'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'C202'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'C301'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'C302'}]
            },
            D: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'D101'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'D102'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'D201'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'D202'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'D301'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'D302'}]
            }
        };

        // å¡«å……æ›´å¤šå‡è³‡æ–™ä»¥é˜²é‡è¤‡
        function expandDB(db) {
            const fruits = [
                {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“'},
                {n:'é³³æ¢¨', en:'PINEAPPLE', i:'ğŸ'}, {n:'æ©˜å­', en:'ORANGE', i:'ğŸŠ'}, {n:'æ¡ƒå­', en:'PEACH', i:'ğŸ‘'}
            ];
            const animals = [
                {n:'ç†Š', en:'BEAR', i:'ğŸ»'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š'},
                {n:'ç†Šè²“', en:'PANDA', i:'ğŸ¼'}, {n:'å…”å­', en:'RABBIT', i:'ğŸ°'}, {n:'è²“å’ª', en:'CAT', i:'ğŸ±'}
            ];
            const plants = [
                {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·'},
                {n:'æ¥“è‘‰', en:'MAPLE', i:'ğŸ'}, {n:'è˜‘è‡', en:'MUSHROOM', i:'ğŸ„'}, {n:'ç«¹å­', en:'BAMBOO', i:'ğŸ‹'}
            ];
            
            ['A','B','C','D'].forEach(role => {
                const prefix = role.charCodeAt(0); // ç”Ÿæˆå¦‚ 65, 66...
                fruits.forEach((item, idx) => database[role].fruits.push({...item, c: `${role}1${idx+10}`}));
                animals.forEach((item, idx) => database[role].animals.push({...item, c: `${role}2${idx+10}`}));
                plants.forEach((item, idx) => database[role].plants.push({...item, c: `${role}3${idx+10}`}));
            });
        }
        expandDB();

        // --- éŠæˆ²ç‹€æ…‹ ---
        let playerCount = 2;
        let myRoleIndex = 0; // 0=A, 1=B, 2=C, 3=D
        let currentLevel = 1;
        
        const roles = [
            {id:'A', color:'var(--highlight-a)', name:'AGENT A'},
            {id:'B', color:'var(--highlight-b)', name:'AGENT B'},
            {id:'C', color:'var(--highlight-c)', name:'AGENT C'},
            {id:'D', color:'var(--highlight-d)', name:'AGENT D'}
        ];
        const phaseOrder = ['fruits', 'animals', 'plants'];
        let currentTarget = null;

        // --- æµç¨‹é‚è¼¯ ---

        function setPlayerCount(n) {
            playerCount = n;
            
            // æ›´æ–° UI é¡¯ç¤ºæŒ‰éˆ•
            document.querySelectorAll('.setup-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            
            const container = document.getElementById('role-buttons');
            container.innerHTML = '';
            
            for(let i=0; i<n; i++) {
                const r = roles[i];
                const btn = document.createElement('button');
                btn.className = 'role-btn';
                btn.onclick = () => startGame(i);
                btn.innerHTML = `<div class="role-indicator" style="background:${r.color}"></div> æˆ‘æ˜¯ ${r.name}`;
                container.appendChild(btn);
            }
            document.getElementById('role-selection').classList.remove('hidden');
        }

        function startGame(roleIdx) {
            myRoleIndex = roleIdx;
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('bottom-bar').classList.remove('hidden');
            
            updateGameState();
        }

        function updateGameState() {
            // 1. è¨ˆç®—å›åˆ (Round Logic)
            // ç¬¬1é—œ(level=1) -> index=0 (A)
            // ç¬¬2é—œ(level=2) -> index=1 (B)
            const activePlayerIndex = (currentLevel - 1) % playerCount;
            const activeRole = roles[activePlayerIndex];
            
            // 2. è¨ˆç®—åŠ©æ‰‹ (Helper Logic) -> ä¸»æ”»æ‰‹çš„ä¸‹ä¸€å€‹äºº
            const helperIndex = (activePlayerIndex + 1) % playerCount;
            const helperRole = roles[helperIndex];

            // 3. æ›´æ–°é ‚éƒ¨è³‡è¨Š
            document.getElementById('level-display').innerText = `LEVEL ${currentLevel}`;
            const turnBadge = document.getElementById('turn-display');
            turnBadge.innerText = `TURN: ${activeRole.name}`;
            turnBadge.style.color = activeRole.color;

            // 4. åˆ¤æ–·æˆ‘æ˜¯èª°
            const isMyTurn = (myRoleIndex === activePlayerIndex);
            const isHelper = (myRoleIndex === helperIndex);

            // 5. UI åˆ‡æ›
            if (isMyTurn) {
                // === ä¸»æ”»æ‰‹æ¨¡å¼ ===
                document.getElementById('active-view').classList.remove('hidden');
                document.getElementById('passive-view').classList.add('hidden');
                
                // è¼‰å…¥é¡Œç›®
                loadTarget(activeRole.id);
                
                // æç¤ºå»å•èª°
                document.getElementById('helper-name').innerText = helperRole.name;
                document.getElementById('helper-name').style.color = helperRole.color;
                
                // éš±è—æˆ–å¼±åŒ–å¯†ç¢¼æœ¬æŒ‰éˆ• (ä¸»æ”»æ‰‹é€šå¸¸ä¸éœ€è¦çœ‹æœ¬å­ï¼Œé™¤éè¦å¹«å¿™ç¢ºèª)
                document.getElementById('btn-book').classList.remove('highlight');
                document.getElementById('btn-book').innerText = "ğŸ“– å¯†ç¢¼æœ¬";

            } else {
                // === å¾…æ©Ÿæ¨¡å¼ ===
                document.getElementById('active-view').classList.add('hidden');
                document.getElementById('passive-view').classList.remove('hidden');
                
                document.getElementById('current-turn-name').innerText = activeRole.name;
                document.getElementById('current-turn-name').style.color = activeRole.color;

                // å¦‚æœæˆ‘æ˜¯åŠ©æ‰‹ï¼ŒæŒ‰éˆ•ç™¼å…‰æç¤º
                const btnBook = document.getElementById('btn-book');
                if (isHelper) {
                    btnBook.classList.add('highlight');
                    btnBook.innerText = `ğŸ“– å¿«å‘Šè¨´ ${activeRole.id} ä»£ç¢¼ï¼`;
                } else {
                    btnBook.classList.remove('highlight');
                    btnBook.innerText = "ğŸ“– å¯†ç¢¼æœ¬";
                }
            }
        }

        function loadTarget(roleId) {
            const catIdx = (currentLevel - 1) % 3; // 0, 1, 2
            const catName = phaseOrder[catIdx];
            
            // é¡Œç›®ä¾†æºï¼šè©²å›åˆä¸»è§’çš„è³‡æ–™åº«
            const list = database[roleId][catName];
            // ç°¡å–® hash é¸æ“‡ (ç‚ºäº†è®“åŒä¸€é—œé¡Œç›®å›ºå®šï¼Œé¿å…é‡æ–°æ•´ç†å¾Œé¡Œç›®è®Šæ‰)
            // é€™è£¡ä½¿ç”¨ currentLevel ä½œç‚ºç¨®å­
            const itemIndex = currentLevel % list.length;
            currentTarget = list[itemIndex]; // é€™è£¡é¸å›ºå®šé¡Œç›®ï¼Œè‹¥è¦éš¨æ©Ÿå¯æ”¹ random
            
            // ç‚ºäº†æ›´æœ‰è¶£ï¼Œé€™è£¡é‚„æ˜¯æ”¹å›éš¨æ©Ÿå¥½äº†ï¼Œåæ­£å¤§å®¶æ‰‹å‹•åŒæ­¥ä¸‹ä¸€é—œ
            currentTarget = list[Math.floor(Math.random() * list.length)];

            document.getElementById('target-icon').innerText = currentTarget.i;
            document.getElementById('target-name').innerText = currentTarget.n;
            document.getElementById('target-en').innerText = currentTarget.en;
            document.getElementById('input-code').value = '';
        }

        function checkCode() {
            const input = document.getElementById('input-code').value.toUpperCase();
            if (input === currentTarget.c) {
                // æˆåŠŸï¼šé¡¯ç¤ºå…¨è¢å¹•æˆåŠŸï¼Œå«å¤§å®¶æŒ‰ä¸‹ä¸€é—œ
                document.getElementById('screen-success').classList.remove('hidden');
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
                document.getElementById('input-code').value = '';
            }
        }

        function manualNextLevel() {
            // æ‰‹å‹•åŒæ­¥ï¼šæ‰€æœ‰äººæŒ‰é€™å€‹éˆ•éƒ½æœƒé€²å…¥ä¸‹ä¸€é—œ
            document.getElementById('screen-success').classList.add('hidden');
            currentLevel++;
            updateGameState();
        }

        // --- å¯†ç¢¼æœ¬é‚è¼¯ ---
        function openCodebook() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const catIdx = (currentLevel - 1) % 3;
            switchTab(phaseOrder[catIdx]);
        }
        function closeCodebook() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
        function switchTab(cat) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            
            // é—œéµï¼šæˆ‘è¦é¡¯ç¤ºã€Œç•¶å‰ä¸»æ”»æ‰‹ã€çš„ç­”æ¡ˆ
            // å› ç‚ºåŠ©æ‰‹æŒæœ‰çš„æ˜¯ã€Œä¸»æ”»æ‰‹ã€çš„å¯†ç¢¼æœ¬
            const activePlayerIndex = (currentLevel - 1) % playerCount;
            const targetRoleID = roles[activePlayerIndex].id;
            
            renderList(database[targetRoleID][cat]);
        }
        function renderList(list) {
            const container = document.getElementById('code-list');
            container.innerHTML = '';
            // æ´—ç‰Œ
            const shuffled = [...list].sort(() => Math.random() - 0.5);
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'code-item';
                div.innerHTML = `<div class="item-icon" style="font-size:2rem;">${item.i}</div>
                                 <div class="item-code">${item.c}</div>`;
                container.appendChild(div);
            });
        }

    </script>
</body>
</html>
