<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TEAM TACTICS v3.4</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            
            /* éšŠä¼é¡è‰² */
            --color-a: #ff3333; /* Red */
            --color-b: #3388ff; /* Blue */
            --color-c: #ffcc00; /* Yellow */
            --color-d: #bd00ff; /* Purple */
            
            --common: #00ff41;      /* Green */
            --danger: #ff3333;      /* Red */
            --warning: #ff6600;     /* Orange */
            --panel-bg: #111111;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- 1. è¨­å®šç•«é¢ --- */
        #screen-setup {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;
        }
        .main-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 30px; letter-spacing: 5px; text-align: center; border: 4px solid #fff; padding: 20px; }
        .setup-title { font-size: 1.2rem; color: #888; margin-bottom: 15px; letter-spacing: 2px; }
        
        .count-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 40px; width: 100%; max-width: 350px; }
        .count-btn {
            padding: 20px; background: #222; border: 2px solid #444; color: #888; font-size: 1.2rem; font-weight: bold; border-radius: 12px;
        }
        .count-btn.selected { background: #333; border-color: var(--common); color: var(--common); box-shadow: 0 0 15px rgba(0,255,65,0.2); }

        .role-list { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 350px; }
        .role-btn {
            padding: 20px; background: #111; border: 2px solid #333; color: #fff; font-size: 1.3rem; font-weight: bold; border-radius: 12px; text-align: left; display: flex; align-items: center;
        }
        .role-dot { width: 15px; height: 15px; border-radius: 50%; margin-right: 15px; }

        /* --- 2. éŠæˆ²ä»‹é¢ --- */
        #screen-game {
            flex: 1; display: flex; flex-direction: column; align-items: center; padding: 15px; 
            padding-top: 90px; /* ç•™çµ¦ä¸Šæ–¹ Header */
            padding-bottom: 100px; /* ç•™çµ¦ä¸‹æ–¹ Footer */
            overflow-y: auto;
            position: relative;
        }

        /* é ‚éƒ¨ Header */
        .header-zone {
            position: fixed; top: 0; left: 0; width: 100%; height: 90px; background: #000; z-index: 40;
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid #333;
        }
        
        /* å·¦ä¸Šè§’é‡ç½®æŒ‰éˆ• */
        .reset-btn {
            background: #220000; color: var(--danger); border: 1px solid var(--danger); 
            padding: 10px 15px; border-radius: 8px; font-weight: bold; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; line-height: 1;
        }

        /* ä¸­é–“/å³å´ï¼šå·¨å¤§çš„é—œå¡é¡¯ç¤º */
        .level-display-box {
            text-align: right; display: flex; flex-direction: column; align-items: flex-end;
        }
        .level-label { font-size: 0.8rem; color: #888; letter-spacing: 2px; }
        .level-number { font-size: 2.5rem; font-weight: 900; color: #fff; line-height: 1; }
        .turn-info { font-size: 0.9rem; font-weight: bold; margin-top: 2px; }

        /* ä¸»æ§æ¨¡å¼ */
        .active-zone { width: 100%; max-width: 400px; text-align: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        .target-card {
            background: rgba(255,255,255,0.08); border: 1px solid #444; border-radius: 16px; padding: 20px; margin-bottom: 20px;
        }
        .target-icon { font-size: 5rem; display: block; margin-bottom: 5px; animation: float 3s infinite; }
        .target-name { font-size: 2rem; font-weight: 900; color: #fff; line-height: 1.2; }
        .target-en { font-size: 1.2rem; color: var(--common); font-weight: bold; letter-spacing: 1px; margin-top: 5px; }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        .hint-box {
            background: rgba(255,255,255,0.1); border: 1px dashed #888; padding: 12px; border-radius: 8px;
            margin-bottom: 20px; font-size: 1.1rem; color: #fff; display: block;
        }

        .input-wrapper { width: 100%; margin-bottom: 15px; }
        .lives-display { margin-bottom: 5px; font-size: 1.5rem; letter-spacing: 5px; min-height: 30px; }
        
        .game-input {
            width: 100%; background: #000; border: 3px solid #555; color: #fff;
            font-size: 2.5rem; padding: 15px; text-align: center; border-radius: 12px;
            outline: none; letter-spacing: 3px; text-transform: uppercase;
        }
        
        .unlock-btn {
            width: 100%; padding: 18px; font-size: 1.5rem; font-weight: 900;
            border: none; border-radius: 12px; cursor: pointer; background: #fff; color: #000;
        }

        /* å¾…æ©Ÿæ¨¡å¼ */
        .passive-zone { width: 100%; max-width: 400px; text-align: center; margin-top: 60px; opacity: 0.8; }
        .wait-icon { font-size: 4rem; margin-bottom: 20px; display: block; filter: grayscale(100%); }
        .wait-text { font-size: 1.5rem; color: #888; margin-bottom: 10px; }
        .wait-target { font-size: 1.2rem; font-weight: bold; color: #fff; }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 90px;
            background: #111; border-top: 1px solid #333; z-index: 50;
            display: flex; align-items: center; padding: 0 15px; justify-content: space-between;
        }
        
        .book-btn {
            flex: 2; height: 60px; border-radius: 12px; margin-right: 10px;
            background: #000; border: 2px solid #444; color: #888; font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .book-btn.highlight {
            background: var(--common); border-color: var(--common); color: #000;
            box-shadow: 0 0 15px rgba(0,255,65,0.4); animation: pulseBtn 1s infinite alternate;
        }
        @keyframes pulseBtn { from {transform: scale(1);} to {transform: scale(1.02);} }

        .next-btn {
            flex: 1; height: 60px; border-radius: 12px;
            background: #222; border: 2px solid #555; color: #fff; font-size: 1rem; font-weight: bold;
        }

        /* --- 3. è¦–çª— (Modal) - ä¿®æ­£ç‰ˆ --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 100; display: flex; flex-direction: column;
        }
        .modal-header { 
            padding: 15px; background: #222; border-bottom: 1px solid #444; 
            display: flex; align-items: center; justify-content: space-between;
        }
        
        /* å·¦ä¸Šè§’æ˜é¡¯çš„è¿”å›æŒ‰éˆ• */
        .back-btn {
            background: #333; border: 1px solid #666; color: #fff; 
            padding: 10px 20px; border-radius: 8px; font-size: 1rem; font-weight: bold;
            display: flex; align-items: center; cursor: pointer;
        }
        .back-btn span { font-size: 1.2rem; margin-right: 5px; }
        
        .modal-info { text-align: right; }
        .modal-title { font-size: 1rem; color: #888; display: block; }
        .modal-subtitle { font-size: 1.2rem; font-weight: bold; color: var(--common); display: block; }

        .tabs { display: flex; background: #000; padding: 10px; gap: 5px; }
        .tab-btn { flex: 1; padding: 15px 0; background: #111; color: #666; border: 1px solid #333; border-radius: 8px; font-weight: bold; font-size: 1.1rem; }
        .tab-btn.active { background: #222; color: var(--common); border-color: var(--common); }
        
        #code-list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; padding-bottom: 50px; }
        .code-item { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .item-code { color: var(--common); font-size: 1.5rem; font-weight: 900; margin: 5px 0; letter-spacing: 1px; }
        .item-en { color: #fff; font-size: 0.8rem; font-weight: bold; }
        .item-cn { color: #888; font-size: 0.8rem; }

        /* --- 4. ç‹€æ…‹ç•«é¢ --- */
        #screen-success, #screen-fail {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 95;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        #screen-success { background: rgba(0,40,0,0.98); }
        #screen-fail { background: rgba(40,0,0,0.98); }
        
        .status-icon { font-size: 7rem; margin-bottom: 20px; display: block; }
        .status-title { font-size: 3rem; font-weight: 900; margin-bottom: 10px; letter-spacing: 2px; }
        .status-msg { font-size: 1.2rem; color: rgba(255,255,255,0.8); margin-bottom: 40px; line-height: 1.5; }
        .action-btn {
            padding: 20px 50px; font-size: 1.5rem; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

    </style>
</head>
<body>

    <div id="screen-setup">
        <div class="main-title">TEAM<br>TACTICS</div>
        
        <div class="setup-title">é¸æ“‡ç‰¹å‹™äººæ•¸</div>
        <div class="count-grid">
            <button class="count-btn" onclick="setPlayerCount(2)">2 äºº</button>
            <button class="count-btn" onclick="setPlayerCount(3)">3 äºº</button>
            <button class="count-btn" onclick="setPlayerCount(4)">4 äºº</button>
        </div>

        <div id="role-area" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="setup-title">é¸æ“‡ä½ çš„èº«åˆ†</div>
            <div id="role-list" class="role-list"></div>
        </div>
    </div>

    <div id="screen-game" class="hidden">
        <div class="header-zone">
            <button class="reset-btn" onclick="confirmReset()">
                <span>â†»</span> é‡ç½®
            </button>
            
            <div class="level-display-box">
                <span class="level-label">LEVEL</span>
                <span class="level-number" id="level-num">1</span>
                <span class="turn-info" id="turn-display">TURN: A</span>
            </div>
        </div>

        <div id="active-view" class="active-zone hidden">
            <div class="target-card">
                <span id="target-icon" class="target-icon">â“</span>
                <div id="target-name" class="target-name">LOADING...</div>
                <div id="target-en" class="target-en">LOADING...</div>
            </div>

            <div class="hint-box">
                ğŸ“¡ å‘ <span id="helper-name" style="font-weight:bold; font-size:1.2rem;">AGENT ?</span> ç´¢å–
            </div>

            <div class="input-wrapper">
                <div class="lives-display" id="lives-box">â¤ï¸â¤ï¸â¤ï¸</div>
                <input type="text" id="input-code" class="game-input" placeholder="CODE" maxlength="4">
            </div>
            <button id="unlock-btn" class="unlock-btn" onclick="checkCode()">è§£é– / UNLOCK</button>
        </div>

        <div id="passive-view" class="passive-zone hidden">
            <div class="wait-icon">ğŸ›¡ï¸</div>
            <div class="wait-text">SYSTEM STANDBY</div>
            <div class="wait-target">ç­‰å¾…éšŠå‹è¡Œå‹•...</div>
            <div style="margin-top:20px; color:#fff; font-weight:bold; font-size:1.2rem;">ç›®å‰å›åˆï¼š<span id="passive-turn-name">AGENT ?</span></div>
        </div>
        
        <div class="bottom-bar">
            <button id="btn-book" class="book-btn" onclick="openCodebook()">ğŸ“– å¯†ç¢¼æœ¬</button>
            <button class="next-btn" onclick="manualNextLevel()">ä¸‹ä¸€é—œ â­</button>
        </div>
    </div>

    <div id="screen-success" class="hidden">
        <div class="status-icon">âœ…</div>
        <div class="status-title" style="color:var(--common);">SUCCESS</div>
        <div class="status-msg">ä»»å‹™å®Œæˆï¼<br>è«‹å…¨é«”ç‰¹å‹™æŒ‰ä¸‹ã€Œä¸‹ä¸€é—œã€</div>
        <button class="action-btn" style="background:var(--common); color:#000;" onclick="manualNextLevel()">ä¸‹ä¸€é—œ â­</button>
    </div>

    <div id="screen-fail" class="hidden">
        <div class="status-icon">ğŸ’¥</div>
        <div class="status-title" style="color:var(--danger);">FAILED</div>
        <div class="status-msg">ä»»å‹™å¤±æ•—ï¼<br>è«‹å¤§è²å‘ŠçŸ¥éšŠå‹é‡ç½®ç³»çµ±ï¼</div>
        <button class="action-btn" style="background:var(--danger); color:#fff;" onclick="fullReset()">â†» å…¨å“¡é‡ç½®</button>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-header">
            <button class="back-btn" onclick="closeCodebook()">
                <span>â¬…</span> è¿”å›
            </button>
            <div class="modal-info">
                <span class="modal-title">æ­£åœ¨æŸ¥è©¢</span>
                <span class="modal-subtitle" id="modal-turn-info">LEVEL 1 (A)</span>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('fruits')" id="tab-fruits">æ°´æœ</button>
            <button class="tab-btn" onclick="switchTab('animals')" id="tab-animals">å‹•ç‰©</button>
            <button class="tab-btn" onclick="switchTab('plants')" id="tab-plants">æ¤ç‰©</button>
        </div>
        <div id="code-list"></div>
    </div>

    <script>
        // --- 1. ç¡¬ç·¨ç¢¼è³‡æ–™åº« (å›ºå®šå¯†ç¢¼) ---
        const database = {
            A: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'X7K9'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'M3R2'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'H8V5'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'T2B6'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'P9L4'}, {n:'é³³æ¢¨', en:'PINEAPPLE', i:'ğŸ', c:'N4J8'}, {n:'æ©˜å­', en:'ORANGE', i:'ğŸŠ', c:'W5Q2'}, {n:'æª¸æª¬', en:'LEMON', i:'ğŸ‹', c:'R9F3'}, {n:'æ¡ƒå­', en:'PEACH', i:'ğŸ‘', c:'Z6C7'}, {n:'æ«»æ¡ƒ', en:'CHERRY', i:'ğŸ’', c:'K2Y5'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'W4N7'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'J6Q3'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'Z2F8'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'K5Y9'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'R8C2'}, {n:'ç†Šè²“', en:'PANDA', i:'ğŸ¼', c:'T7D4'}, {n:'ç„¡å°¾ç†Š', en:'KOALA', i:'ğŸ¨', c:'M9H2'}, {n:'å…”å­', en:'RABBIT', i:'ğŸ°', c:'P3X6'}, {n:'è²“å’ª', en:'CAT', i:'ğŸ±', c:'B5L8'}, {n:'ç‹—ç‹—', en:'DOG', i:'ğŸ¶', c:'G4S9'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'B7M3'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'D4G9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'S5X2'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'V9H6'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'L3T8'}, {n:'æ¥“è‘‰', en:'MAPLE', i:'ğŸ', c:'Q2N5'}, {n:'è˜‘è‡', en:'MUSHROOM', i:'ğŸ„', c:'F8R4'}, {n:'ç«¹å­', en:'BAMBOO', i:'ğŸ‹', c:'C6J9'}, {n:'æ¤°å­æ¨¹', en:'PALM', i:'ğŸŒ´', c:'Y7K2'}, {n:'å¹¸é‹è‰', en:'CLOVER', i:'ğŸ€', c:'P4W3'}]
            },
            B: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'C8J2'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'F5N9'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'Y3W7'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'Q6P4'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'A9K5'}, {n:'é³³æ¢¨', en:'PINEAPPLE', i:'ğŸ', c:'R2M8'}, {n:'æ©˜å­', en:'ORANGE', i:'ğŸŠ', c:'T7H3'}, {n:'æª¸æª¬', en:'LEMON', i:'ğŸ‹', c:'L4V6'}, {n:'æ¡ƒå­', en:'PEACH', i:'ğŸ‘', c:'G9X2'}, {n:'æ«»æ¡ƒ', en:'CHERRY', i:'ğŸ’', c:'D3B5'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'R2D8'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'M7V3'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'T4L6'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'H9B2'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'G5X8'}, {n:'ç†Šè²“', en:'PANDA', i:'ğŸ¼', c:'N3K9'}, {n:'ç„¡å°¾ç†Š', en:'KOALA', i:'ğŸ¨', c:'P6F4'}, {n:'å…”å­', en:'RABBIT', i:'ğŸ°', c:'C2W7'}, {n:'è²“å’ª', en:'CAT', i:'ğŸ±', c:'Y8S5'}, {n:'ç‹—ç‹—', en:'DOG', i:'ğŸ¶', c:'J4Q2'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'S6Z4'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'K3C9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'W8F2'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'J5Y7'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'P2M6'}, {n:'æ¥“è‘‰', en:'MAPLE', i:'ğŸ', c:'B9H3'}, {n:'è˜‘è‡', en:'MUSHROOM', i:'ğŸ„', c:'T4R8'}, {n:'ç«¹å­', en:'BAMBOO', i:'ğŸ‹', c:'L7G5'}, {n:'æ¤°å­æ¨¹', en:'PALM', i:'ğŸŒ´', c:'X2D9'}, {n:'å¹¸é‹è‰', en:'CLOVER', i:'ğŸ€', c:'V6N4'}]
            },
            C: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'L4H9'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'Z7K3'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'X2N6'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'B5R8'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'V3T9'}, {n:'é³³æ¢¨', en:'PINEAPPLE', i:'ğŸ', c:'M8P2'}, {n:'æ©˜å­', en:'ORANGE', i:'ğŸŠ', c:'F6J4'}, {n:'æª¸æª¬', en:'LEMON', i:'ğŸ‹', c:'C9W5'}, {n:'æ¡ƒå­', en:'PEACH', i:'ğŸ‘', c:'Q4Y7'}, {n:'æ«»æ¡ƒ', en:'CHERRY', i:'ğŸ’', c:'G2S3'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'Q9J4'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'W6M2'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'F8P5'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'C3D7'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'Y5G2'}, {n:'ç†Šè²“', en:'PANDA', i:'ğŸ¼', c:'K4R9'}, {n:'ç„¡å°¾ç†Š', en:'KOALA', i:'ğŸ¨', c:'T2B6'}, {n:'å…”å­', en:'RABBIT', i:'ğŸ°', c:'H7N3'}, {n:'è²“å’ª', en:'CAT', i:'ğŸ±', c:'S9L5'}, {n:'ç‹—ç‹—', en:'DOG', i:'ğŸ¶', c:'V4X8'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'H7S3'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'T2L9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'K6B4'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'R9X5'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'M4V8'}, {n:'æ¥“è‘‰', en:'MAPLE', i:'ğŸ', c:'P3C7'}, {n:'è˜‘è‡', en:'MUSHROOM', i:'ğŸ„', c:'D8F2'}, {n:'ç«¹å­', en:'BAMBOO', i:'ğŸ‹', c:'J5Q6'}, {n:'æ¤°å­æ¨¹', en:'PALM', i:'ğŸŒ´', c:'N2G9'}, {n:'å¹¸é‹è‰', en:'CLOVER', i:'ğŸ€', c:'W7Y4'}]
            },
            D: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'G3Y6'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'P7W2'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'J9F4'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'N5K8'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'D2R9'}, {n:'é³³æ¢¨', en:'PINEAPPLE', i:'ğŸ', c:'H6L3'}, {n:'æ©˜å­', en:'ORANGE', i:'ğŸŠ', c:'X4M7'}, {n:'æª¸æª¬', en:'LEMON', i:'ğŸ‹', c:'B8T5'}, {n:'æ¡ƒå­', en:'PEACH', i:'ğŸ‘', c:'S2V9'}, {n:'æ«»æ¡ƒ', en:'CHERRY', i:'ğŸ’', c:'F5C4'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'S8T3'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'L6H2'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'V4C7'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'B9M5'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'Z3Q6'}, {n:'ç†Šè²“', en:'PANDA', i:'ğŸ¼', c:'R5N2'}, {n:'ç„¡å°¾ç†Š', en:'KOALA', i:'ğŸ¨', c:'K8J4'}, {n:'å…”å­', en:'RABBIT', i:'ğŸ°', c:'G2P9'}, {n:'è²“å’ª', en:'CAT', i:'ğŸ±', c:'D7W3'}, {n:'ç‹—ç‹—', en:'DOG', i:'ğŸ¶', c:'X5F8'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'X5J8'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'R7N3'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'F2W9'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'C6P4'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'Y8K2'}, {n:'æ¥“è‘‰', en:'MAPLE', i:'ğŸ', c:'M3G7'}, {n:'è˜‘è‡', en:'MUSHROOM', i:'ğŸ„', c:'H9D5'}, {n:'ç«¹å­', en:'BAMBOO', i:'ğŸ‹', c:'T4B6'}, {n:'æ¤°å­æ¨¹', en:'PALM', i:'ğŸŒ´', c:'L2S8'}, {n:'å¹¸é‹è‰', en:'CLOVER', i:'ğŸ€', c:'Q5V3'}]
            }
        };

        // --- 2. éŠæˆ²ç‹€æ…‹ ---
        let playerCount = 2;
        let myRoleIndex = 0;
        let currentLevel = 1;
        let lives = 3;
        const maxLives = 3;
        let currentTarget = null;

        const roles = [
            {id:'A', name:'AGENT A', color:'var(--color-a)'},
            {id:'B', name:'AGENT B', color:'var(--color-b)'},
            {id:'C', name:'AGENT C', color:'var(--color-c)'},
            {id:'D', name:'AGENT D', color:'var(--color-d)'}
        ];
        const phaseOrder = ['fruits', 'animals', 'plants'];

        // --- 3. è¨­å®šæµç¨‹ ---
        function setPlayerCount(n) {
            playerCount = n;
            document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            
            const list = document.getElementById('role-list');
            list.innerHTML = '';
            for(let i=0; i<n; i++) {
                const r = roles[i];
                const btn = document.createElement('button');
                btn.className = 'role-btn';
                btn.onclick = () => startGame(i);
                btn.innerHTML = `<div class="role-dot" style="background:${r.color}"></div>æˆ‘æ˜¯ ${r.name}`;
                list.appendChild(btn);
            }
            document.getElementById('role-area').classList.remove('hidden');
        }

        function startGame(idx) {
            myRoleIndex = idx;
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            
            // ä¸»é¡Œè‰²
            document.getElementById('unlock-btn').style.background = roles[myRoleIndex].color;
            document.getElementById('unlock-btn').style.color = '#fff';
            
            updateGameState();
        }

        // --- 4. æ ¸å¿ƒé‚è¼¯ ---
        function updateGameState() {
            // è¨ˆç®—å›åˆä¸»è§’
            const activeIndex = (currentLevel - 1) % playerCount;
            const activeRole = roles[activeIndex];
            
            // è¨ˆç®—åŠ©æ‰‹
            const helperIndex = (activeIndex + 1) % playerCount;
            const helperRole = roles[helperIndex];

            // é ‚éƒ¨æ›´æ–° (æ”¾å¤§é¡¯ç¤º)
            document.getElementById('level-num').innerText = currentLevel;
            const turnBadge = document.getElementById('turn-display');
            turnBadge.innerText = `TURN: ${activeRole.id}`;
            turnBadge.style.color = activeRole.color;

            const isMyTurn = (myRoleIndex === activeIndex);
            const isHelper = (myRoleIndex === helperIndex);

            if (isMyTurn) {
                // === ä¸»æ”»æ‰‹ ===
                document.getElementById('active-view').classList.remove('hidden');
                document.getElementById('passive-view').classList.add('hidden');
                document.getElementById('btn-book').classList.remove('highlight');
                
                document.getElementById('helper-name').innerText = helperRole.name;
                document.getElementById('helper-name').style.color = helperRole.color;
                
                resetLives();
                loadTarget(activeRole.id);

            } else {
                // === å¾…æ©Ÿè€… ===
                document.getElementById('active-view').classList.add('hidden');
                document.getElementById('passive-view').classList.remove('hidden');
                
                document.getElementById('passive-turn-name').innerText = activeRole.name;
                document.getElementById('passive-turn-name').style.color = activeRole.color;
                
                const bookBtn = document.getElementById('btn-book');
                if (isHelper) {
                    bookBtn.classList.add('highlight');
                    bookBtn.innerHTML = `ğŸ“– å¿«å‘Šè¨´ ${activeRole.id} ä»£ç¢¼ï¼`;
                } else {
                    bookBtn.classList.remove('highlight');
                    bookBtn.innerHTML = `ğŸ“– å¯†ç¢¼æœ¬`;
                }
            }
        }

        function loadTarget(roleId) {
            const catIdx = (currentLevel - 1) % 3;
            const catName = phaseOrder[catIdx];
            const list = database[roleId][catName];
            
            // éš¨æ©Ÿé¸é¡Œ
            currentTarget = list[Math.floor(Math.random() * list.length)];
            
            document.getElementById('target-icon').innerText = currentTarget.i;
            document.getElementById('target-name').innerText = currentTarget.n;
            document.getElementById('target-en').innerText = currentTarget.en;
            document.getElementById('input-code').value = '';
        }

        function resetLives() {
            lives = maxLives;
            updateLivesUI();
        }
        
        function updateLivesUI() {
            let html = '';
            for(let i=0; i<lives; i++) html += 'â¤ï¸';
            for(let i=lives; i<maxLives; i++) html += 'ğŸ–¤';
            document.getElementById('lives-box').innerHTML = html;
        }

        function checkCode() {
            const input = document.getElementById('input-code').value.toUpperCase().trim();
            if (input === currentTarget.c) {
                document.getElementById('screen-success').classList.remove('hidden');
            } else {
                lives--;
                updateLivesUI();
                document.getElementById('input-code').value = '';
                
                const wrap = document.querySelector('.input-wrapper');
                wrap.animate([{transform:'translateX(0)'}, {transform:'translateX(10px)'}, {transform:'translateX(-10px)'}, {transform:'translateX(0)'}], {duration:200});

                if (lives <= 0) {
                    setTimeout(() => document.getElementById('screen-fail').classList.remove('hidden'), 300);
                }
            }
        }

        // --- 5. æµç¨‹æ§åˆ¶ ---
        function manualNextLevel() {
            document.getElementById('screen-success').classList.add('hidden');
            currentLevel++;
            updateGameState();
        }

        function confirmReset() {
            if(confirm('âš  è­¦å‘Šï¼šç¢ºå®šè¦é‡ç½®ä»»å‹™å—ï¼Ÿ\næ‰€æœ‰äººçš„é€²åº¦å°‡æœƒæ¶ˆå¤±ï¼Œå›åˆ°é¦–é ã€‚')) {
                fullReset();
            }
        }

        function fullReset() {
            location.reload();
        }

        // --- 6. å¯†ç¢¼æœ¬ ---
        function openCodebook() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const catIdx = (currentLevel - 1) % 3;
            switchTab(phaseOrder[catIdx]);
            
            // æ›´æ–°å¯†ç¢¼æœ¬æ¨™é¡Œè³‡è¨Š
            const activeIndex = (currentLevel - 1) % playerCount;
            const activeRole = roles[activeIndex];
            document.getElementById('modal-turn-info').innerText = `LEVEL ${currentLevel} (${activeRole.name})`;
            document.getElementById('modal-turn-info').style.color = activeRole.color;
        }
        function closeCodebook() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
        function switchTab(cat) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            
            // é¡¯ç¤ºã€Œç•¶å‰ä¸»æ”»æ‰‹ã€çš„ç­”æ¡ˆ
            const activeIndex = (currentLevel - 1) % playerCount;
            const targetRoleID = roles[activeIndex].id;
            renderList(database[targetRoleID][cat]);
        }
        function renderList(list) {
            const container = document.getElementById('code-list');
            container.innerHTML = '';
            // æ´—ç‰Œ
            const shuffled = [...list].sort(() => Math.random() - 0.5);
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'code-item';
                div.innerHTML = `
                    <div style="font-size:2rem;">${item.i}</div>
                    <div class="item-code">${item.c}</div>
                    <div class="item-en">${item.en}</div>
                    <div class="item-cn">${item.n}</div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
