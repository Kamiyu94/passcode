<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TEAM TACTICS v3.0</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            
            /* éšŠä¼é¡è‰² */
            --color-a: #ff3333; /* Red */
            --color-b: #3388ff; /* Blue */
            --color-c: #ffcc00; /* Yellow */
            --color-d: #bd00ff; /* Purple */
            
            --common: #00ff41;      /* Green */
            --danger: #ff0000;      /* Explosion Red */
            --panel-bg: #111111;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ²å‹•ï¼Œæ”¹ç”¨å…§éƒ¨æ²å‹• */
        }

        .hidden { display: none !important; }

        /* --- 1. è¨­å®šç•«é¢ (Setup) --- */
        #screen-setup {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;
        }
        .setup-title { font-size: 1.2rem; color: #888; margin-bottom: 15px; letter-spacing: 2px; text-transform: uppercase; }
        .main-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 40px; letter-spacing: 5px; text-align: center; border: 4px solid #fff; padding: 20px; }
        
        .count-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 30px; width: 100%; max-width: 350px; }
        .count-btn {
            padding: 15px; background: #222; border: 2px solid #444; color: #888; font-size: 1.2rem; font-weight: bold; border-radius: 8px; cursor: pointer;
        }
        .count-btn.selected { background: #333; border-color: var(--common); color: var(--common); box-shadow: 0 0 15px rgba(0,255,65,0.2); }

        .role-list { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 350px; }
        .role-btn {
            padding: 18px; background: #111; border: 2px solid #333; color: #fff; font-size: 1.2rem; font-weight: bold; border-radius: 10px; text-align: left; display: flex; align-items: center; transition: transform 0.1s;
        }
        .role-btn:active { transform: scale(0.98); }
        .role-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 15px; }

        /* --- 2. éŠæˆ²ä»‹é¢ (Game) --- */
        #screen-game {
            flex: 1; display: flex; flex-direction: column; align-items: center; padding: 15px; 
            padding-bottom: 100px; /* é ç•™åº•éƒ¨ç©ºé–“ */
            overflow-y: auto;
        }

        /* é ‚éƒ¨è³‡è¨Š */
        .top-bar {
            width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px;
        }
        .level-badge { background: #222; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; }
        .turn-info { font-weight: bold; font-size: 1rem; }

        /* ä¸»æ§æ¨¡å¼ (Active) */
        .active-zone { width: 100%; max-width: 400px; text-align: center; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        .target-card {
            background: rgba(255,255,255,0.08); border: 1px solid #444; border-radius: 16px; padding: 20px; margin-bottom: 20px;
        }
        .target-icon { font-size: 5rem; display: block; margin-bottom: 5px; animation: float 3s infinite; }
        .target-name { font-size: 2rem; font-weight: 900; color: #fff; line-height: 1.2; }
        .target-en { font-size: 1.2rem; color: var(--common); font-weight: bold; letter-spacing: 1px; margin-top: 5px;}
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        .hint-box {
            background: rgba(0,0,0,0.5); border: 1px dashed #666; padding: 10px; border-radius: 8px;
            margin-bottom: 20px; font-size: 1rem; color: #ccc; display: inline-block;
        }

        .input-wrapper { width: 100%; position: relative; margin-bottom: 15px; }
        .lives-display { margin-bottom: 5px; font-size: 1.2rem; letter-spacing: 5px; min-height: 24px; }
        
        .game-input {
            width: 100%; background: #000; border: 3px solid #555; color: #fff;
            font-size: 2.5rem; padding: 10px; text-align: center; border-radius: 12px;
            outline: none; letter-spacing: 3px; text-transform: uppercase; font-family: inherit;
        }
        .game-input:focus { border-color: #fff; }

        .unlock-btn {
            width: 100%; padding: 15px; font-size: 1.5rem; font-weight: 900;
            border: none; border-radius: 12px; cursor: pointer;
            background: var(--common); color: #000; box-shadow: 0 5px 20px rgba(0,255,65,0.3);
        }
        .unlock-btn:active { transform: scale(0.98); filter: brightness(0.9); }

        /* å¾…æ©Ÿæ¨¡å¼ (Passive) */
        .passive-zone { width: 100%; max-width: 400px; text-align: center; margin-top: 40px; opacity: 0.7; }
        .wait-icon { font-size: 4rem; margin-bottom: 20px; display: block; filter: grayscale(100%); }
        .wait-text { font-size: 1.2rem; color: #888; margin-bottom: 10px; }
        .wait-target { font-size: 1.5rem; font-weight: bold; }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 90px;
            background: #111; border-top: 1px solid #333; z-index: 50;
            display: flex; align-items: center; padding: 0 15px; justify-content: space-between;
        }
        
        .book-btn {
            flex: 2; height: 60px; border-radius: 12px; margin-right: 10px;
            background: #000; border: 2px solid #444; color: #888; font-size: 1.1rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .book-btn.highlight {
            background: var(--common); border-color: var(--common); color: #000;
            box-shadow: 0 0 15px rgba(0,255,65,0.4); animation: pulseBtn 1s infinite alternate;
        }
        @keyframes pulseBtn { from {transform: scale(1);} to {transform: scale(1.02);} }

        .next-btn {
            flex: 1; height: 60px; border-radius: 12px;
            background: #222; border: 2px solid #555; color: #fff; font-size: 1rem; font-weight: bold;
        }
        
        /* å°é‡ç½®æŒ‰éˆ• */
        .reset-mini {
            position: absolute; top: -40px; right: 15px;
            background: #333; color: #888; border: 1px solid #555; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem;
        }

        /* --- 3. è¦–çª— (Modal) --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 100; display: flex; flex-direction: column;
        }
        .modal-header { padding: 15px; background: #222; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; background: #000; padding: 10px; gap: 5px; }
        .tab-btn { flex: 1; padding: 10px 0; background: #111; color: #666; border: 1px solid #333; border-radius: 6px; font-weight: bold; }
        .tab-btn.active { background: #222; color: var(--common); border-color: var(--common); }
        #code-list { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .code-item { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .item-code { color: var(--common); font-size: 1.4rem; font-weight: 900; margin: 5px 0; letter-spacing: 1px; }
        .item-en { color: #fff; font-size: 0.8rem; font-weight: bold; }
        .item-cn { color: #888; font-size: 0.8rem; }

        /* --- 4. ç‹€æ…‹ç•«é¢ (æˆåŠŸ/å¤±æ•—) --- */
        #screen-success, #screen-fail {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 95;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        #screen-success { background: rgba(0,40,0,0.98); }
        #screen-fail { background: rgba(40,0,0,0.98); }
        
        .status-icon { font-size: 6rem; margin-bottom: 20px; display: block; }
        .status-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 10px; letter-spacing: 2px; }
        .status-msg { font-size: 1.2rem; color: rgba(255,255,255,0.8); margin-bottom: 40px; }
        
        .action-btn {
            padding: 15px 40px; font-size: 1.5rem; font-weight: bold; border-radius: 50px; border: none; cursor: pointer; box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

    </style>
</head>
<body>

    <div id="screen-setup">
        <div class="main-title">TEAM<br>TACTICS</div>
        
        <div class="setup-title">é¸æ“‡ç‰¹å‹™äººæ•¸</div>
        <div class="count-grid">
            <button class="count-btn" onclick="setPlayerCount(2)">2 äºº</button>
            <button class="count-btn" onclick="setPlayerCount(3)">3 äºº</button>
            <button class="count-btn" onclick="setPlayerCount(4)">4 äºº</button>
        </div>

        <div id="role-area" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="setup-title">é¸æ“‡ä½ çš„èº«åˆ†</div>
            <div id="role-list" class="role-list">
                </div>
        </div>
    </div>

    <div id="screen-game" class="hidden">
        <div class="top-bar">
            <div class="level-badge" id="level-display">LEVEL 1</div>
            <div class="turn-info" id="turn-display">TURN: A</div>
        </div>

        <div id="active-view" class="active-zone hidden">
            <div class="target-card">
                <span id="target-icon" class="target-icon">â“</span>
                <div id="target-name" class="target-name">LOADING...</div>
                <div id="target-en" class="target-en">LOADING...</div>
            </div>

            <div class="hint-box">
                ğŸ“¡ è«‹æ±‚æ”¯æ´ï¼šå‘ <span id="helper-name" style="font-weight:bold; color:#fff;">AGENT ?</span> ç´¢å–ä»£ç¢¼
            </div>

            <div class="input-wrapper">
                <div class="lives-display" id="lives-box">â¤ï¸â¤ï¸â¤ï¸</div>
                <input type="text" id="input-code" class="game-input" placeholder="CODE" maxlength="4">
            </div>
            <button id="unlock-btn" class="unlock-btn" onclick="checkCode()">è§£é– / UNLOCK</button>
        </div>

        <div id="passive-view" class="passive-zone hidden">
            <div class="wait-icon">ğŸ›¡ï¸</div>
            <div class="wait-text">SYSTEM STANDBY</div>
            <div class="wait-target">ç­‰å¾…éšŠå‹è¡Œå‹•...</div>
            <div style="margin-top:20px; color:#555;">ç›®å‰å›åˆï¼š<span id="passive-turn-name">AGENT ?</span></div>
        </div>
        
        <div class="bottom-bar">
            <button class="reset-mini" onclick="confirmReset()">â†» é‡ç½®ä»»å‹™</button>
            <button id="btn-book" class="book-btn" onclick="openCodebook()">ğŸ“– å¯†ç¢¼æœ¬</button>
            <button class="next-btn" onclick="manualNextLevel()">ä¸‹ä¸€é—œ â­</button>
        </div>
    </div>

    <div id="screen-success" class="hidden">
        <div class="status-icon">âœ…</div>
        <div class="status-title" style="color:var(--common);">SUCCESS</div>
        <div class="status-msg">ä»»å‹™å®Œæˆï¼è«‹å…¨é«”æŒ‰ä¸‹ã€Œä¸‹ä¸€é—œã€</div>
        <button class="action-btn" style="background:var(--common); color:#000;" onclick="manualNextLevel()">ä¸‹ä¸€é—œ â­</button>
    </div>

    <div id="screen-fail" class="hidden">
        <div class="status-icon">ğŸ’¥</div>
        <div class="status-title" style="color:var(--danger);">FAILED</div>
        <div class="status-msg">ä»»å‹™å¤±æ•—ï¼è«‹å¤§è²å‘ŠçŸ¥éšŠå‹ï¼</div>
        <button class="action-btn" style="background:var(--danger); color:#fff;" onclick="fullReset()">â†» å…¨å“¡é‡ç½®</button>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-header">
            <div style="color:#fff; font-weight:bold;">å”åŠ©éšŠå‹</div>
            <button style="background:none; border:none; color:#fff; font-size:2rem;" onclick="closeCodebook()">âœ•</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('fruits')" id="tab-fruits">æ°´æœ</button>
            <button class="tab-btn" onclick="switchTab('animals')" id="tab-animals">å‹•ç‰©</button>
            <button class="tab-btn" onclick="switchTab('plants')" id="tab-plants">æ¤ç‰©</button>
        </div>
        <div id="code-list"></div>
    </div>

    <script>
        // --- 1. ç¡¬ç·¨ç¢¼è³‡æ–™åº« (Hardcoded Database) ---
        // æ ¼å¼ï¼šè‹±æ–‡ + æ•¸å­—æ··åˆï¼Œé¿å… I,O,0,1
        const database = {
            A: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'X7K9'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'M3R2'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'H8V5'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'T2B6'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'P9L4'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'W4N7'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'J6Q3'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'Z2F8'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'K5Y9'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'R8C2'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'B7M3'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'D4G9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'S5X2'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'V9H6'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'L3T8'}]
            },
            B: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'C8J2'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'F5N9'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'Y3W7'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'Q6P4'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'A9K5'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'R2D8'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'M7V3'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'T4L6'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'H9B2'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'G5X8'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'S6Z4'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'K3C9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'W8F2'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'J5Y7'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'P2M6'}]
            },
            C: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'L4H9'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'Z7K3'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'X2N6'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'B5R8'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'V3T9'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'Q9J4'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'W6M2'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'F8P5'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'C3D7'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'Y5G2'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'H7S3'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'T2L9'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'K6B4'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'R9X5'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'M4V8'}]
            },
            D: {
                fruits: [{n:'é¦™è•‰', en:'BANANA', i:'ğŸŒ', c:'G3Y6'}, {n:'è˜‹æœ', en:'APPLE', i:'ğŸ', c:'P7W2'}, {n:'è‘¡è„', en:'GRAPE', i:'ğŸ‡', c:'J9F4'}, {n:'è¥¿ç“œ', en:'WATERMELON', i:'ğŸ‰', c:'N5K8'}, {n:'è‰è“', en:'STRAWBERRY', i:'ğŸ“', c:'D2R9'}],
                animals: [{n:'ç…å­', en:'LION', i:'ğŸ¦', c:'S8T3'}, {n:'è€è™', en:'TIGER', i:'ğŸ¯', c:'L6H2'}, {n:'ç†Š', en:'BEAR', i:'ğŸ»', c:'V4C7'}, {n:'ç‹¼', en:'WOLF', i:'ğŸº', c:'B9M5'}, {n:'ç‹ç‹¸', en:'FOX', i:'ğŸ¦Š', c:'Z3Q6'}],
                plants: [{n:'ä»™äººæŒ', en:'CACTUS', i:'ğŸŒµ', c:'X5J8'}, {n:'æ¾æ¨¹', en:'PINE', i:'ğŸŒ²', c:'R7N3'}, {n:'å‘æ—¥è‘µ', en:'SUNFLOWER', i:'ğŸŒ»', c:'F2W9'}, {n:'ç«ç‘°', en:'ROSE', i:'ğŸŒ¹', c:'C6P4'}, {n:'é¬±é‡‘é¦™', en:'TULIP', i:'ğŸŒ·', c:'Y8K2'}]
            }
        };

        // --- 2. éŠæˆ²ç‹€æ…‹ ---
        let playerCount = 2;
        let myRoleIndex = 0;
        let currentLevel = 1;
        let lives = 3;
        const maxLives = 3;
        let currentTarget = null;

        const roles = [
            {id:'A', name:'AGENT A', color:'var(--color-a)'},
            {id:'B', name:'AGENT B', color:'var(--color-b)'},
            {id:'C', name:'AGENT C', color:'var(--color-c)'},
            {id:'D', name:'AGENT D', color:'var(--color-d)'}
        ];
        const phaseOrder = ['fruits', 'animals', 'plants'];

        // --- 3. è¨­å®šæµç¨‹ ---
        function setPlayerCount(n) {
            playerCount = n;
            document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            
            const list = document.getElementById('role-list');
            list.innerHTML = '';
            for(let i=0; i<n; i++) {
                const r = roles[i];
                const btn = document.createElement('button');
                btn.className = 'role-btn';
                btn.onclick = () => startGame(i);
                btn.innerHTML = `<div class="role-dot" style="background:${r.color}"></div>æˆ‘æ˜¯ ${r.name}`;
                list.appendChild(btn);
            }
            document.getElementById('role-area').classList.remove('hidden');
        }

        function startGame(idx) {
            myRoleIndex = idx;
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            
            // è¨­å®šæˆ‘çš„ä¸»é¡Œè‰²
            const myColor = roles[myRoleIndex].color;
            document.getElementById('unlock-btn').style.background = myColor;
            
            updateGameState();
        }

        // --- 4. æ ¸å¿ƒé‚è¼¯ (Game Loop) ---
        function updateGameState() {
            // è¨ˆç®—é€™ä¸€å±€æ˜¯èª°çš„ Turn
            const activeIndex = (currentLevel - 1) % playerCount;
            const activeRole = roles[activeIndex];
            
            // è¨ˆç®—åŠ©æ‰‹ (Active çš„ä¸‹ä¸€å€‹)
            const helperIndex = (activeIndex + 1) % playerCount;
            const helperRole = roles[helperIndex];

            // UI æ›´æ–°
            document.getElementById('level-display').innerText = `LEVEL ${currentLevel}`;
            const turnBadge = document.getElementById('turn-display');
            turnBadge.innerText = `TURN: ${activeRole.id}`;
            turnBadge.style.color = activeRole.color;

            const isMyTurn = (myRoleIndex === activeIndex);
            const isHelper = (myRoleIndex === helperIndex);

            // åˆ‡æ›è¦–åœ–
            if (isMyTurn) {
                // === ä¸»æ”»æ‰‹ ===
                document.getElementById('active-view').classList.remove('hidden');
                document.getElementById('passive-view').classList.add('hidden');
                document.getElementById('btn-book').classList.remove('highlight'); // ä¸»æ”»æ‰‹ä¸è©²æŸ¥æœ¬å­
                
                // æ›´æ–°æç¤º
                document.getElementById('helper-name').innerText = helperRole.name;
                document.getElementById('helper-name').style.color = helperRole.color;
                
                // è¼‰å…¥é¡Œç›® & é‡ç½®ç”Ÿå‘½
                resetLives();
                loadTarget(activeRole.id);

            } else {
                // === å¾…æ©Ÿè€… ===
                document.getElementById('active-view').classList.add('hidden');
                document.getElementById('passive-view').classList.remove('hidden');
                document.getElementById('passive-turn-name').innerText = activeRole.name;
                document.getElementById('passive-turn-name').style.color = activeRole.color;
                
                // åŠ©æ‰‹é«˜äº®æç¤º
                const bookBtn = document.getElementById('btn-book');
                if (isHelper) {
                    bookBtn.classList.add('highlight');
                    bookBtn.innerHTML = `ğŸ“– å¿«å‘Šè¨´ ${activeRole.id} ä»£ç¢¼ï¼`;
                } else {
                    bookBtn.classList.remove('highlight');
                    bookBtn.innerHTML = `ğŸ“– å¯†ç¢¼æœ¬`;
                }
            }
        }

        function loadTarget(roleId) {
            const catIdx = (currentLevel - 1) % 3;
            const catName = phaseOrder[catIdx];
            const list = database[roleId][catName];
            
            // éš¨æ©Ÿé¸é¡Œ
            currentTarget = list[Math.floor(Math.random() * list.length)];
            
            document.getElementById('target-icon').innerText = currentTarget.i;
            document.getElementById('target-name').innerText = currentTarget.n;
            document.getElementById('target-en').innerText = currentTarget.en;
            document.getElementById('input-code').value = '';
        }

        function resetLives() {
            lives = maxLives;
            updateLivesUI();
        }
        
        function updateLivesUI() {
            let html = '';
            for(let i=0; i<lives; i++) html += 'â¤ï¸';
            for(let i=lives; i<maxLives; i++) html += 'ğŸ–¤';
            document.getElementById('lives-box').innerHTML = html;
        }

        function checkCode() {
            const input = document.getElementById('input-code').value.toUpperCase().trim();
            
            if (input === currentTarget.c) {
                // æˆåŠŸ
                document.getElementById('screen-success').classList.remove('hidden');
            } else {
                // å¤±æ•—
                lives--;
                updateLivesUI();
                document.getElementById('input-code').value = '';
                
                // éœ‡å‹•å›é¥‹
                const wrap = document.querySelector('.input-wrapper');
                wrap.animate([
                    {transform:'translateX(0)'}, {transform:'translateX(10px)'}, 
                    {transform:'translateX(-10px)'}, {transform:'translateX(0)'}
                ], {duration:200});

                if (lives <= 0) {
                    setTimeout(() => {
                        document.getElementById('screen-fail').classList.remove('hidden');
                    }, 300);
                }
            }
        }

        // --- 5. æµç¨‹æ§åˆ¶ ---
        function manualNextLevel() {
            document.getElementById('screen-success').classList.add('hidden');
            currentLevel++;
            updateGameState();
        }

        function confirmReset() {
            if(confirm('ç¢ºå®šè¦é‡ç½®ä»»å‹™å—ï¼Ÿ\né€™æœƒå›åˆ°é¦–é ï¼Œæ‰€æœ‰äººé€²åº¦æ­¸é›¶ã€‚')) {
                fullReset();
            }
        }

        function fullReset() {
            location.reload();
        }

        // --- 6. å¯†ç¢¼æœ¬é‚è¼¯ ---
        function openCodebook() {
            document.getElementById('modal-overlay').classList.remove('hidden');
            const catIdx = (currentLevel - 1) % 3;
            switchTab(phaseOrder[catIdx]);
        }
        function closeCodebook() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
        function switchTab(cat) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            
            // æ°¸é é¡¯ç¤ºã€Œç•¶å‰ä¸»æ”»æ‰‹ã€çš„ç­”æ¡ˆ
            const activeIndex = (currentLevel - 1) % playerCount;
            const targetRoleID = roles[activeIndex].id;
            renderList(database[targetRoleID][cat]);
        }
        function renderList(list) {
            const container = document.getElementById('code-list');
            container.innerHTML = '';
            // æ´—ç‰Œ
            const shuffled = [...list].sort(() => Math.random() - 0.5);
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'code-item';
                div.innerHTML = `
                    <div style="font-size:2rem;">${item.i}</div>
                    <div class="item-code">${item.c}</div>
                    <div class="item-en">${item.en}</div>
                    <div class="item-cn">${item.n}</div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
